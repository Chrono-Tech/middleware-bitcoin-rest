
module.exports.id = '4ea9c35.157583c';

const _ = require('lodash'),
  config = require('../config');

/**
 * @description flow 4ea9c35.157583c update
 * @param done
 */
   

module.exports.up = function (done) {
  let coll = this.db.collection(`${_.get(config, 'nodered.mongo.collectionPrefix', '')}noderedstorages`);
  coll.update({"path":"4ea9c35.157583c","type":"flows"}, {
    $set: {"path":"4ea9c35.157583c","body":[{"id":"596ca35a.c156cc","type":"http in","z":"4ea9c35.157583c","name":"height","url":"/blocks/height","method":"get","upload":false,"swaggerDoc":"","x":110,"y":80,"wires":[["f89f3989.dd26e8"]]},{"id":"dee303ce.dea29","type":"mongo","z":"4ea9c35.157583c","model":"","request":"{}","options":"{}","name":"mongo","mode":"1","requestType":"0","dbAlias":"primary.data","x":470,"y":80,"wires":[["5b51682c.88a4a8"]]},{"id":"f89f3989.dd26e8","type":"function","z":"4ea9c35.157583c","name":"prepare block request","func":"const prefix = global.get('settings.mongo.collectionPrefix');\n\n\nmsg.payload = { \n    model: `${prefix}Block`, \n    request: {},\n    options: {\n      sort: {number: -1},\n      limit: 1\n  }\n};\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":80,"wires":[["dee303ce.dea29"]]},{"id":"5b51682c.88a4a8","type":"function","z":"4ea9c35.157583c","name":"prepare response","func":"const prefix = global.get('settings.mongo.collectionPrefix');\nconst _ = global.get('_');\n\nconst blockNumber = _.get(msg.payload, '0.number', -1);\n\nmsg.payload = {currentBlock: blockNumber};\n\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":80,"wires":[["64fb2da7.9f7744"]]},{"id":"64fb2da7.9f7744","type":"http response","z":"4ea9c35.157583c","name":"","statusCode":"","headers":{},"x":850,"y":80,"wires":[]},{"id":"df7255df.121dd8","type":"catch","z":"4ea9c35.157583c","name":"","scope":null,"x":120,"y":300,"wires":[["9270930f.3bafd","acc44e74.2a206"]]},{"id":"fdb45efa.4f158","type":"http response","z":"4ea9c35.157583c","name":"","statusCode":"","x":577,"y":301,"wires":[]},{"id":"9270930f.3bafd","type":"function","z":"4ea9c35.157583c","name":"transform","func":"let factories = global.get(\"factories\"); \n\nmsg.payload = factories.messages.generic.fail;\n   \nreturn msg;","outputs":1,"noerr":0,"x":361,"y":300,"wires":[["fdb45efa.4f158"]]},{"id":"acc44e74.2a206","type":"debug","z":"4ea9c35.157583c","name":"","active":true,"console":"false","complete":"error","x":380,"y":360,"wires":[]},{"id":"af26a755.9edac8","type":"http in","z":"4ea9c35.157583c","name":"last hash","url":"/blocks/last/hash","method":"get","upload":false,"swaggerDoc":"","x":120,"y":140,"wires":[["6be3f0f2.fa344"]]},{"id":"8eec57b8.5ab948","type":"mongo","z":"4ea9c35.157583c","model":"","request":"{}","options":"{}","name":"mongo","mode":"1","requestType":"0","dbAlias":"primary.data","x":490,"y":140,"wires":[["e8eff1e2.daa48"]]},{"id":"6be3f0f2.fa344","type":"function","z":"4ea9c35.157583c","name":"prepare block request","func":"const prefix = global.get('settings.mongo.collectionPrefix');\n\n\nmsg.payload = { \n    model: `${prefix}Block`, \n    request: {},\n    options: {\n      sort: {number: -1},\n      limit: 1\n  }\n};\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":140,"wires":[["8eec57b8.5ab948"]]},{"id":"e8eff1e2.daa48","type":"function","z":"4ea9c35.157583c","name":"prepare response","func":"const prefix = global.get('settings.mongo.collectionPrefix');\nconst _ = global.get('_');\n\nconst hash = _.get(msg.payload, '0._id', '');\nmsg.payload = {currentBlockHash: hash};\n\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":140,"wires":[["5751cc72.4c9ca4"]]},{"id":"5751cc72.4c9ca4","type":"http response","z":"4ea9c35.157583c","name":"","statusCode":"","headers":{},"x":870,"y":140,"wires":[]},{"id":"64ed78e6.7ac5a8","type":"http in","z":"4ea9c35.157583c","name":"get block","url":"/blocks/info/:hashOrNumber","method":"get","upload":false,"swaggerDoc":"","x":120,"y":220,"wires":[["dcea87f7.f3d788"]]},{"id":"457aa1a9.5a49f","type":"mongo","z":"4ea9c35.157583c","model":"","request":"{}","options":"{}","name":"mongo","mode":"1","requestType":"0","dbAlias":"primary.data","x":610,"y":220,"wires":[["48558b85.66d8f4"]]},{"id":"dcea87f7.f3d788","type":"function","z":"4ea9c35.157583c","name":"prepare block request","func":"const prefix = global.get('settings.mongo.collectionPrefix');\nconst _ = global.get('_');\n\nconst param = msg.req.params.hashOrNumber;\n\nmsg.payload = [{ \n    model: `${prefix}Block`, \n    request: new RegExp(/^[^a-zA-Z]+$/).test(param) ? {number: parseInt(param)} : {_id: param},\n    options: {\n      limit: 1\n  }\n},\n{ \n    model: `${prefix}Block`, \n    request: {},\n    options: {\n      sort: {number: -1},\n      limit: 1\n  }\n}];\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":220,"wires":[["93697089.43707"]]},{"id":"8c600000.ced39","type":"function","z":"4ea9c35.157583c","name":"prepare response","func":"const prefix = global.get('settings.mongo.collectionPrefix');\nconst _ = global.get('_');\n\nconst blocks = _.flattenDeep(msg.payload);\n\nif(blocks.length < 2){\n    msg.payload = {};\n    return msg;\n}\n\n\nconst maxBlock = _.maxBy(blocks, 'number', {});\nconst currentBlock = _.minBy(blocks, 'number', {});\nconst block = _.get(msg.payload, '0', {});\n\nmsg.payload = {\n    hash: currentBlock._id,\n    number: currentBlock.number,\n    merkleRoot: currentBlock.merkleRoot,\n    timestamp: currentBlock.timestamp,\n    confirmations: maxBlock.number - currentBlock.number + 1\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":930,"y":220,"wires":[["ec0aa97d.c17488"]]},{"id":"ec0aa97d.c17488","type":"http response","z":"4ea9c35.157583c","name":"","statusCode":"","headers":{},"x":1130,"y":220,"wires":[]},{"id":"93697089.43707","type":"split","z":"4ea9c35.157583c","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":470,"y":220,"wires":[["457aa1a9.5a49f"]]},{"id":"48558b85.66d8f4","type":"join","z":"4ea9c35.157583c","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":750,"y":220,"wires":[["8c600000.ced39"]]}]}
  }, {upsert: true}, done);
};

module.exports.down = function (done) {
  let coll = this.db.collection(`${_.get(config, 'nodered.mongo.collectionPrefix', '')}noderedstorages`);
  coll.remove({"path":"4ea9c35.157583c","type":"flows"}, done);
};
