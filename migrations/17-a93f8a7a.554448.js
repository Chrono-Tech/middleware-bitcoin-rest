
module.exports.id = '17.a93f8a7a.554448';

const _ = require('lodash'),
  config = require('../config');

/**
 * @description flow a93f8a7a.554448 update
 * @param done
 */
   

module.exports.up = function (done) {
  let coll = this.db.collection(`${_.get(config, 'nodered.mongo.collectionPrefix', '')}noderedstorages`);
  coll.update({"path":"a93f8a7a.554448","type":"flows"}, {
    $set: {"path":"a93f8a7a.554448","body":[{"id":"b8040c57.02071","type":"http in","z":"a93f8a7a.554448","name":"height","url":"insights/api/blocks/height","method":"get","upload":false,"swaggerDoc":"","x":110,"y":100,"wires":[["b749f3d4.f3e7e"]]},{"id":"b749f3d4.f3e7e","type":"function","z":"a93f8a7a.554448","name":"","func":"const prefix = global.get('settings.mongo.collectionPrefix');\nconst _ = global.get('_');\n\nmsg.address = msg.req.params.addr;\n\n\nmsg.payload ={ \n    model: `${prefix}Block`, \n    request: {number: {$ne: -1}},\n  options: {\n      sort: {timestamp: -1},\n      limit: parseInt(msg.req.query.limit) || 1,\n      skip:  0\n  }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":100,"wires":[["9edd83cf.916e8"]]},{"id":"9edd83cf.916e8","type":"mongo","z":"a93f8a7a.554448","model":"","request":"{}","options":"{}","name":"mongo","mode":"1","requestType":"0","dbAlias":"primary.data","x":410,"y":100,"wires":[["a31c21e0.6fed3"]]},{"id":"b2d7a7ef.ce4378","type":"http response","z":"a93f8a7a.554448","name":"","statusCode":"","x":710,"y":100,"wires":[]},{"id":"a31c21e0.6fed3","type":"function","z":"a93f8a7a.554448","name":"","func":"const _ = global.get('_');\n\n\n\nmsg.payload = {height: _.get(msg.payload, '0.number', 0)};\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":100,"wires":[["b2d7a7ef.ce4378"]]},{"id":"2367c3a8.0f3d6c","type":"http in","z":"a93f8a7a.554448","name":"get block list","url":"/insights/api/blocks","method":"get","upload":false,"swaggerDoc":"","x":90,"y":200,"wires":[["63a1d2a.bf1682c"]]},{"id":"63a1d2a.bf1682c","type":"function","z":"a93f8a7a.554448","name":"","func":"const prefix = global.get('settings.mongo.collectionPrefix');\nconst _ = global.get('_');\n\nlet request = {number: {$ne: -1}};\n\nif(msg.payload.min)\n    request.number.$gte = msg.payload.min;\n\nif(msg.payload.max)\n    request.number.$lte = msg.payload.max;\n\n\nmsg.payload ={ \n    model: `${prefix}Block`, \n    request: request,\n  options: {\n      sort: {timestamp: -1},\n      limit: 100,\n      skip: 0\n  }\n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":200,"wires":[["ff0219d.0dae8e8"]]},{"id":"ff0219d.0dae8e8","type":"mongo","z":"a93f8a7a.554448","model":"","request":"{}","options":"{}","name":"mongo","mode":"1","requestType":"0","dbAlias":"primary.data","x":410,"y":200,"wires":[["8e386894.788ba8"]]},{"id":"4c53056b.87b43c","type":"http response","z":"a93f8a7a.554448","name":"","statusCode":"","x":710,"y":200,"wires":[]},{"id":"8e386894.788ba8","type":"function","z":"a93f8a7a.554448","name":"","func":"const _ = global.get('_');\n\n\n\n//msg.payload = {height: _.get(msg.payload, '0.number', 0)};\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":200,"wires":[["4c53056b.87b43c"]]},{"id":"88607270.33a0e","type":"function","z":"a93f8a7a.554448","name":"","func":"const prefix = global.get('settings.mongo.collectionPrefix');\nconst _ = global.get('_');\n\nlet request = _.isNumber(msg.req.params.hash) ?\n{number: msg.req.params.hash} :\n{hash: msg.req.params.hash};\n\nmsg.payload ={ \n    model: `${prefix}Block`, \n    request: request,\n    options: {\n      limit: 1\n  }\n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":280,"wires":[["895532e7.1a17e"]]},{"id":"895532e7.1a17e","type":"mongo","z":"a93f8a7a.554448","model":"","request":"{}","options":"{}","name":"mongo","mode":"1","requestType":"0","dbAlias":"primary.data","x":410,"y":280,"wires":[["20382448.d7e18c"]]},{"id":"b12060a1.1dd75","type":"http response","z":"a93f8a7a.554448","name":"","statusCode":"","x":970,"y":280,"wires":[]},{"id":"20382448.d7e18c","type":"function","z":"a93f8a7a.554448","name":"","func":"const _ = global.get('_');\nconst prefix = global.get('settings.mongo.collectionPrefix');\n\n\nmsg.block = _.get(msg.payload, '0', {});\n\n\nmsg.payload ={ \n    model: `${prefix}Tx`, \n    request: {\n        blockNumber: msg.block.number\n    },\n    options: {\n     \n  }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":280,"wires":[["2f60392a.29c3e6"]]},{"id":"2f60392a.29c3e6","type":"mongo","z":"a93f8a7a.554448","model":"","request":"{}","options":"{}","name":"mongo","mode":"1","requestType":"0","dbAlias":"primary.data","x":710,"y":280,"wires":[["9b6b8450.33e238"]]},{"id":"9b6b8450.33e238","type":"function","z":"a93f8a7a.554448","name":"","func":"const _ = global.get('_');\n\n\nmsg.block.txs = msg.payload;\n\nmsg.payload = msg.block;\n\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":280,"wires":[["b12060a1.1dd75"]]},{"id":"3a79dbed.689eb4","type":"http in","z":"a93f8a7a.554448","name":"get tx","url":"/insights/api/tx/:hash","method":"get","upload":false,"swaggerDoc":"","x":70,"y":380,"wires":[["a3b14015.9c4e"]]},{"id":"9c92bf04.7fea7","type":"http response","z":"a93f8a7a.554448","name":"","statusCode":"","x":630,"y":380,"wires":[]},{"id":"a3b14015.9c4e","type":"function","z":"a93f8a7a.554448","name":"","func":"const _ = global.get('_');\nconst prefix = global.get('settings.mongo.collectionPrefix');\n\n\nmsg.payload ={ \n    model: `${prefix}Tx`, \n    request: {\n        hash: msg.req.params.hash\n    },\n    options: {\n     \n  }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":380,"wires":[["a38628d5.bda388"]]},{"id":"a38628d5.bda388","type":"mongo","z":"a93f8a7a.554448","model":"","request":"{}","options":"{}","name":"mongo","mode":"1","requestType":"0","dbAlias":"primary.data","x":370,"y":380,"wires":[["eaf54fb3.f6ffd"]]},{"id":"eaf54fb3.f6ffd","type":"function","z":"a93f8a7a.554448","name":"","func":"const tx = msg.payload[0] || {};\n\nmsg.payload = tx;\n\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":380,"wires":[["9c92bf04.7fea7"]]},{"id":"8cc1bf5f.a5a15","type":"http in","z":"a93f8a7a.554448","name":"get block","url":"/insights/api/blocks/:hash","method":"get","upload":false,"swaggerDoc":"","x":80,"y":280,"wires":[["88607270.33a0e"]]}]}
  }, {upsert: true}, done);
};

module.exports.down = function (done) {
  let coll = this.db.collection(`${_.get(config, 'nodered.mongo.collectionPrefix', '')}noderedstorages`);
  coll.remove({"path":"a93f8a7a.554448","type":"flows"}, done);
};
